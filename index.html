<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    
    <!-- Include the CesiumJS JavaScript and CSS files -->
    <script>
      window.$ = window.jQuery = require('./assets/js/jquery.js');
    </script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <link rel="stylesheet" type="text/css" href="./assets/gauges/css/flightindicators.css" />

    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.9.2/umd/popper.min.js" integrity="sha512-2rNj2KJ+D8s1ceNasTIex6z4HWyOnEYLVC3FigGOmyQCZc2eBXKgOxQmo3oKLHyfcj53uz4QMsRCWNbLd32Q1g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>-->
    
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.83/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.83/Build/Cesium/Cesium.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
    <script src="./classes/map/Leaflet.ImageOverlay.Rotated.js"></script>
    <title>DATAD</title>


  </head>
  <body style="height: 1000px;max-height: 1000px;overflow:hidden">
    <div class="container main container" style="margin: 0;padding: 10px 5px;width: 100%;max-width: 100%;">
      <div class="row">
        <div class="col-sm-4" style="padding: 0;">
          <div class="row">
            <div class="col-sm-6" style="padding: 0px 10px">
              <div class="row">

                <div class="col-sm-12" style="padding: 0;">
                  <div id="connessione_centralina"></div>
                </div>

                <div class="col-sm-12" style="padding: 0;">
                  <div id="layoutManager"></div>
                </div>

                <div class="col-sm-12" >
                  <div id="adsb_container" style="display: none;"></div>
                </div>

              </div>
            </div>
            <div class="col-sm-6" style="padding: 0px 10px">
              <div id="flight_data" style="padding: 0;display: block;"></div>
              <!--<div id="antennaGPS" style="display: block;"></div>-->
            </div>
          </div>
          <div class="row" style="padding: 0;">
            <div class="col-sm-12" style="padding: 0px 10px">
              <div id="map_container"></div>
            </div>
          </div>
        </div>
        <div class="col-sm-8" id="cesiumBox" style="text-align: center;position: relative;min-height: 1030px;padding: 0px 10px">

          <canvas width="100px" height="400px" id="altitudeCanvas" style="border-radius:10px;display: none;right: 15px;top: 25%;z-index:999999999;position:absolute;background-color: rgba(0, 0, 0, 0.5)"></canvas>
          <canvas width="100px" height="400px" id="speedCanvas" style="border-radius:10px;display: none;left: 15px;top: 25%;z-index:999999999;position:absolute;background-color: rgba(0, 0, 0, 0.5)"></canvas>
          <canvas width="1230px" height="100px" id="myCanvas" style="border-radius:10px;display: none;left:15px;z-index:999999999;position:absolute;background-color: rgba(0, 0, 0, 0.5);border-bottom-left-radius: 12px;border-bottom-right-radius: 12px;bottom: 0"></canvas>
          <canvas width="680px" height="680px" id="pitchCanvas" style="border-radius:10px;display: none;top:160px;left:290px;position: absolute;;z-index: 99999;"></canvas>
          <canvas width="1000px" height="800px" id="horizonCanvas" style="border-radius:10px;display:none;left:130px;top:100px;z-index:9999;position: absolute;"></canvas>
          <canvas width="1000px" height="800px" id="horizonBarCanvas" style="border-radius:10px;display:none;left:130px;top:100px;z-index:99999;position: absolute;"></canvas>


          <div id="overlayCommands" class="row" style="position: relative;z-index: 999999"></div>

            <div id="cesiumContainer" style="max-height: 1100px;max-width: 1270px;width: 100%;height: 1100px !Important"></div>

            <div id="planeCamera" style="position: absolute;max-width: 1230px;width: 100%">
              <div id="container">
                <canvas id="canvasVideo" width='1230' height='1000' style="display: none"></canvas>
                <div id="loadingCamera" style="width: 1000px;height: 1000px;position: relative"></div>

              </div>
            </div>
          <div id="modalLink"></div>

            <div id="tettolone" style="padding: 0;position: absolute;bottom:0;width: 100%;"></div>
        </div>
      </div>
    </div>
    <div id="modals"></div>
  </body>

  <script src="./assets/gauges/js/jquery.flightindicators.js"></script>
  <script>
    const JQueryGaugesListeners = require("./classes/renderData/JQueryGaugesListeners").JQueryGaugesListeners;
    const JQueryParameterRenderer = require("./classes/renderData/JQueryParameterRenderer").JQueryParameterRenderer;
    const DatadCesium = require('./classes/DatadCesium').DatadCesium;
    const PortConnection = require('./classes/portConnection/PortConnection').PortConnection;
    const FlightData = require('./classes/dataReader/FlightData').FlightData;
    const CustomAlert = require('./classes/utility/CustomAlert').CustomAlert;
    const MavlinkParams = require('./classes/dataReader/MavlinkParams').MavlinkParams;
    const AdsbPlaneList = require("./classes/adsb/AdsbPlaneList").AdsbPlaneList;
    const Settings = require("./classes/utility/Settings").Settings;
    const PlaneCamera = require("./classes/camera/Camera").Camera;

    $('#cesiumContainer').height("1040px")

    $(document).ready(() => {

        const yCoord = 44.647129;
        const xCoord = 10.925227;
        let deg = 0;
        const planeImg = "./assets/img/jet-plane-svgrepo-com.svg"

        const map = L.map('map').setView([yCoord, xCoord], 19);

        const googleSat = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{
          maxZoom: 20,
          subdomains:['mt0','mt1','mt2','mt3']
        }).addTo(map)

        const marker = L.marker([44.647129, 10.925227]).addTo(map).bindPopup('<b>Hello world!</b><br />I am a popup.').openPopup();

        /*const circle = L.circle([51.508, -0.11], {
            color: 'red',
            fillColor: '#f03',
            fillOpacity: 0.5,
            radius: 500
        }).addTo(map).bindPopup('I am a circle.');*/

        /*const polygon = L.polygon([
            [51.509, -0.08],
            [51.503, -0.06],
            [51.51, -0.047]
        ]).addTo(map).bindPopup('I am a polygon.');*/


        /*const popup = L.popup()
            .setLatLng([51.513, -0.09])
            .setContent('I am a standalone popup.')
            .openOn(map);*/

      function onMapClick(e) {
        L.popup()
                .setLatLng(e.latlng)
                .setContent(`You clicked the map at ${e.latlng.toString()}`)
                .openOn(map);
      }

      map.on('click', onMapClick);


      let zoom = map._zoom

      let dimValues = 0;

      switch (zoom){
        case 20: dimValues = 0.000050; break;
        case 19: dimValues = 0.000100; break;
        case 18: dimValues = 0.000200; break;
        case 17: dimValues = 0.000400; break;
        case 16: dimValues = 0.000700; break;
        case 15: dimValues = 0.001200; break;
        case 14: dimValues = 0.002000; break;
        case 13: dimValues = 0.004000; break;
        case 12: dimValues = 0.007000; break;
        case 11: dimValues = 0.012000; break;
        case 10: dimValues = 0.02000; break;
        default: dimValues = 0.02;
      }

      let centerX = xCoord;
      let centerY = yCoord;

      let leftUpperCorner_x = xCoord-dimValues;
      let leftUpperCorner_y = yCoord+dimValues;

      let rightUpperCorner_x = xCoord+dimValues;
      let rightUpperCorner_y = yCoord+dimValues;

      let leftBottomCorner_x = xCoord-dimValues;
      let leftBottomCorner_y = yCoord-dimValues;

      let rotation = 90;

      let topLeftNotCoords = rotate(centerX,centerY,leftUpperCorner_x,leftUpperCorner_y,0);
      let topRightNotCoords = rotate(centerX,centerY,rightUpperCorner_x,rightUpperCorner_y,0);
      let bottomLeftNotCoords = rotate(centerX,centerY,leftBottomCorner_x,leftBottomCorner_y,0);

      let topleft = L.latLng(topLeftNotCoords[1],topLeftNotCoords[0])
      let topright = L.latLng(topRightNotCoords[1],topRightNotCoords[0])
      let bottomleft = L.latLng(bottomLeftNotCoords[1],bottomLeftNotCoords[0])

      let imageBounds = [[yCoord-0.000100, xCoord-0.000100], [yCoord+0.000100, xCoord+0.000100]]
      let planeImageNew = L.imageOverlay.rotated(planeImg, topleft, topright, bottomleft).addTo(map);

      let counter = 0;

      setInterval( () =>{

        let zoom = map._zoom

        let dimValues = 0;

        switch (zoom){
          case 20: dimValues = 0.000050; break;
          case 19: dimValues = 0.000100; break;
          case 18: dimValues = 0.000200; break;
          case 17: dimValues = 0.000400; break;
          case 16: dimValues = 0.000700; break;
          case 15: dimValues = 0.001200; break;
          case 14: dimValues = 0.002000; break;
          case 13: dimValues = 0.004000; break;
          case 12: dimValues = 0.007000; break;
          case 11: dimValues = 0.012000; break;
          case 10: dimValues = 0.02000; break;
          default: dimValues = 0.02;
        }



        let centerX = xCoord;
        let centerY = yCoord;

        let leftUpperCorner_x = xCoord-dimValues;
        let leftUpperCorner_y = yCoord+dimValues;

        let rightUpperCorner_x = xCoord+dimValues;
        let rightUpperCorner_y = yCoord+dimValues;

        let leftBottomCorner_x = xCoord-dimValues;
        let leftBottomCorner_y = yCoord-dimValues;

        let rotation = 90;

        let topLeftNotCoords = rotate(centerX,centerY,leftUpperCorner_x,leftUpperCorner_y,deg);
        let topRightNotCoords = rotate(centerX,centerY,rightUpperCorner_x,rightUpperCorner_y,deg);
        let bottomLeftNotCoords = rotate(centerX,centerY,leftBottomCorner_x,leftBottomCorner_y,deg);

        let topleft = L.latLng(topLeftNotCoords[1],topLeftNotCoords[0])
        let topright = L.latLng(topRightNotCoords[1],topRightNotCoords[0])
        let bottomleft = L.latLng(bottomLeftNotCoords[1],bottomLeftNotCoords[0])


        planeImageNew.reposition(topleft, topright, bottomleft)//.addTo(map);

        deg+=0.1;

      },10)


      map.on('zoomend', function() {

        console.log(this._zoom)

        let dimValues = 0;

        switch (this._zoom){
          case 20: dimValues = 0.000050; break;
          case 19: dimValues = 0.000100; break;
          case 18: dimValues = 0.000200; break;
          case 17: dimValues = 0.000400; break;
          case 16: dimValues = 0.000700; break;
          case 15: dimValues = 0.001200; break;
          case 14: dimValues = 0.002000; break;
          case 13: dimValues = 0.004000; break;
          case 12: dimValues = 0.007000; break;
          case 11: dimValues = 0.012000; break;
          case 10: dimValues = 0.02000; break;
          default: dimValues = 0.02;
        }

        map.removeLayer(planeImageNew);


        let centerX = xCoord;
        let centerY = yCoord;

        let leftUpperCorner_x = xCoord-dimValues;
        let leftUpperCorner_y = yCoord+dimValues;

        let rightUpperCorner_x = xCoord+dimValues;
        let rightUpperCorner_y = yCoord+dimValues;

        let leftBottomCorner_x = xCoord-dimValues;
        let leftBottomCorner_y = yCoord-dimValues;

        let rotation = 90;

        let topLeftNotCoords = rotate(centerX,centerY,leftUpperCorner_x,leftUpperCorner_y,deg);
        let topRightNotCoords = rotate(centerX,centerY,rightUpperCorner_x,rightUpperCorner_y,deg);
        let bottomLeftNotCoords = rotate(centerX,centerY,leftBottomCorner_x,leftBottomCorner_y,deg);

        let topleft = L.latLng(topLeftNotCoords[1],topLeftNotCoords[0])
        let topright = L.latLng(topRightNotCoords[1],topRightNotCoords[0])
        let bottomleft = L.latLng(bottomLeftNotCoords[1],bottomLeftNotCoords[0])


        planeImageNew = L.imageOverlay.rotated(planeImg, topleft, topright, bottomleft).addTo(map);

        //console.log(planeImage)

      });

      function rotate(centerX, centerY, x, y, angle) {
        var radians = (Math.PI / 180) * angle,
                cos = Math.cos(radians),
                sin = Math.sin(radians),
                nx = (cos * (x - centerX)) + (sin * (y - centerY)) + centerX,
                ny = (cos * (y - centerY)) - (sin * (x - centerX)) + centerY;
        return [nx, ny];
      }
    })



    /*globalThis.portname = "COM7";
    globalThis.baud = 115200;
    globalThis.portnameWrite = "COM5";
    globalThis.baudWrite = 115200;
    globalThis.connectionStatus = false;
    globalThis.renderCycle = false;
    globalThis.fetchData = false;
    globalThis.lat = 44.647036;
    globalThis.lon = 10.923773;
    globalThis.alt = 120;
    globalThis.heading = Cesium.Math.toRadians(120);
    globalThis.pitch = 0;
    globalThis.roll = 0;
    globalThis.alt_delta=0;
    globalThis.delta_increase = 0;
    globalThis.attitude_time = 0;
    globalThis.current_sium = 1;
    globalThis.current_zoom = 40;
    globalThis.new_heading = 0;
    globalThis.new_pitch = 0;
    globalThis.new_roll = 0;
    //globalThis.first_person = 1;
    globalThis.write_data = false;

    globalThis.AccMin = 1;
    globalThis.AccMax = 1;
    globalThis.Vibr = 0;

    globalThis.paramValueList = []
    globalThis.paramDesc = []

    globalThis.VelRel = 0;

    globalThis.adsbVehicles = [];
    globalThis.adsbMapPlanes = []
    globalThis.adsbMapEntity = []
    globalThis.adsbMapEntityText = []

    globalThis.temp_lat = 0;
    globalThis.temp_lon = 0;
    globalThis.temp_alt = 0;

    globalThis.altitudeGauge = undefined
    globalThis.pressure = undefined

    //Modena
    //globalThis.antennaX = 446854530
    //globalThis.antennaY = 107400070
    //globalThis.antennaZ = 0

    //Casa giovanardi
    globalThis.antennaX = 0
    globalThis.antennaY = 0
    globalThis.antennaZ = 0*/


    window.onload= async function () {

      //Prendi i dati dal file settings.json, dopodichè faccio partire tutto
      Settings.fetchData().then(r => {

        //Salvo i parametri del file nella classe statica
        MavlinkParams.populateParams();

        //Non mi serve istanziare FlightData in quanto classe statica
        DatadCesium.createEverything().then(r => DatadCesium.startRenderLoop());

        new PortConnection();

        //Se voglio fare partire il loop di controllo degli aerei ADSB devo fare
        AdsbPlaneList.createCheckLoop();

        //Creo il listener per i vari bottoni
        JQueryParameterRenderer.createParamsButtonListener();
        JQueryGaugesListeners.createListeners();

        //Preparo la camera
        PlaneCamera.createListener();
      })
    }

  </script>
  
  <script src="moduli_js/utils.js"></script>
  <link href="./assets/css/bootstrap.min.css" rel="stylesheet">
  <link href="./assets/css/style.css" rel="stylesheet">
  <script src="./assets/js/bootstrap.min.js"></script>
  
</html>